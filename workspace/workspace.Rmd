---
title: "Project Workspace"
author: "Energyyy"
output: html_document
---

```{r load-packages, message = FALSE}
library(tidyverse)
library(broom)
#install.packages("lubridate")
library(lubridate)
library(tidyr)
library(readxl)
#install.packages("leaflet")
library(leaflet)
#install.packages("tigris")
#library(tigris)
#options(tigris_use_cache = TRUE)
#install.packages("sf")
library(sf)
#install.packages("magick")
library(magick)
```

```{r read-data}
table_Residential <- read_excel("/cloud/project/data/table_Residential.xlsx",
                                na = c("."))
table_Commercial <- read_excel("/cloud/project/data/table_Commercial.xlsx",
                               na = c("."))
table_Industrial <- read_excel("/cloud/project/data/table_Industrial.xlsx", 
                               na = c("."))
table_Transportation <- read_excel("/cloud/project/data/table_Transportation.xlsx", 
                                   na = c("."))
table_Disturbance <- read_excel("/cloud/project/data/table_Disturbance.xlsx",
                                na= c(".", ". Hours,  . Minutes", "Unknow", ".        ."))
table_CAIDI <- read_excel("/cloud/project/data/table_CAIDI.xlsx")

USA_df <- sf::st_read("/cloud/project/data/USA_States_Generalized.shp")
```

This mutate function adds a column which contains the sector of the data.
```{r mutate-to-sector}
USA_df <- USA_df %>%
 rename(`Census Division\r\nand State` = STATE_NAME)
residential <- table_Residential %>%
  mutate(Sector = c("Residential"))
commercial <- table_Commercial %>%
  mutate(Sector = c("Commercial"))
transportation <- table_Transportation %>%
  mutate(Sector = c("Transportation"))
industrial <- table_Industrial %>%
  mutate(Sector = c("Industrial"))
```

This code binds all the tables with sectors together. 
```{r bind-rows}
energy_sector <- bind_rows(residential, commercial, industrial, transportation)
```

```{r separate-duration-disturbance}
disturbance_unjoined <- table_Disturbance |>
  separate(col = Duration, into = c("Hours (Duration)", "Minutes (Duration)"), sep = ',') 

disturbance <- 
  rename(disturbance_unjoined, Entity = `Utility/Power Pool`) |>
  right_join(energy_sector, by = "Entity")

glimpse(disturbance)
```

```{r pivot-CAIDI}
table_CAIDI <- table_CAIDI |>
 pivot_longer(cols = `2013`:`2022`,
              names_to = "Year",
              values_to = "CAIDI")
```

## 1. Ownership vs price of electricity /according to sector 
- Q: Does ownership e.g. cooperatives influence the average price of electricity, does it benefit individuals/residential sector or is it more geared towards commercial sectorâ€¦?`

```{r ownership-average-price-state}
energy_sector |>
  filter(!is.na(Ownership)) |>
  mutate(
    Ownership = fct_relevel(
      Ownership,
      "Cooperative", "Municipal", "Political Subdivision", "State", "Federal", "Behind the Meter", "Retail Power Marketer", "Investor Owned"
    )) |>

 ggplot(aes(x = as.numeric(Ownership), y = `Average Price (cents/kWh)`)) +
  geom_boxplot(outlier.shape = NA, aes(color = Ownership)) +
  geom_smooth(method = "glm", color = "black") +
  ylim(0,25)+
  facet_wrap(~Sector) +
  scale_color_manual(values = c("Cooperative" = "#ffffd9", "Municipal" = "#edf8b1", "Political Subdivision" = "#c7e9b4", "State" = "#7fcdbb", "Federal" = "#41b6c4", "Behind the Meter" = "#1d91c0", "Retail Power Marketer" = "#225ea8", "Investor Owned" = "#0c2c84")) +
  theme(axis.text.x = element_text(
    angle = 45, vjust = 1, hjust  = 1), plot.margin = margin(1, 0.1, 1, 1, unit = "mm")) +
  labs(
    title = "Does ownership type of the utility company influence the average price of electricity?",
    subtitle = "Per sector based on 2022 data",
    caption = "Source : https://www.eia.gov/electricity/data.php#sales",
    x = ""
  )
#ggsave(filename = "plot1.png", device = "png")
```

# 2a. Revenue and actual blackouts and ownership 
  - Q: does less profit and community owned mean less blackouts? Or does ownership tell us that big companies have more means to prevent blackouts?

- aes(x = Revenue, y = n of blackouts, color = ownership) +
- geom_point()

- finish cleaning up company names in Excel
- join tables by utility company name

```{r count-disturbances-per-companies}
disturbance |> 
  group_by(Entity) |>
  count() |>
  arrange(n)
```

For the next plot we want to count the disturbances per utility company. However, we need to clean up the data first because some companies come up with different names. Hence, the mutate function. 
```{r mutate-to-group-same-companies-different-names}
disturbance |>
  mutate(Company = 
           case_when(
    `Entity` %in% 
      c("American Electric Power (Regulated Generation)", 
      "American Electric Power - (RFC Reliability Region) (8400 Smiths Mill Road, New Albany Ohio 43054)")
        ~ "American Electric Power", 
     `Entity` %in% 
      c("Baltimore Gas & Electric Co", 	
"Baltimore Gas and Electric") ~ "Baltimore Gas & Electric",
     TRUE ~ as.character(as.character(`Entity`))
    )) |>
    group_by(Company) |>
  count()
  
#ggplot(aes(x = `Average Price (cents/kWh)`, y = `Revenues (Thousands Dollars)`, size = n of blackouts/in categories)), facet(~ ownership)
```
  
# 2b. CAIDI reliability in electricity networks throughout the US based on states
Q: How does CAIDI vary throughout the US states? 
Animate leaflet from 2013-2022. 

```{r join-US-states-geometry-to-CAIDI, eval=FALSE}
#Data contains states and regions. Thus, we filter for states only.
table_CAIDI <- table_CAIDI %>%
  filter(`Census Division\r\nand State` %in% c(
  "Alabama", "Alaska", "Arizona", "Arkansas", "California", "Colorado", "Connecticut", "Delaware", "Florida", "Georgia", "Hawaii", "Idaho", "Illinois", "Indiana", "Iowa", "Kansas", "Kentucky", "Louisiana", "Maine", "Maryland", "Massachusetts", "Michigan", "Minnesota", "Mississippi", "Missouri", "Montana", "Nebraska", "Nevada", "New Hampshire", "New Jersey", "New Mexico", "New York", "North Carolina", "North Dakota", "Ohio", "Oklahoma", "Oregon", "Pennsylvania", "Rhode Island", "South Carolina",  "South Dakota", "Tennessee", "Texas", "Utah", "Vermont", "Virginia", "Washington", "West Virginia", "Wisconsin", "Wyoming", "Illinois", "Montana", "District of Columbia"))

USA_df <- USA_df %>%
  select("Census Division\r\nand State")
```

```{r filter-MajorEventDays-FALSE, eval=FALSE}
CAIDI_leaflet_df <- 
  merge(USA_df, table_CAIDI, by = "Census Division\r\nand State")

CAIDI_leaflet_df <- CAIDI_leaflet_df %>%
  filter(`Major Event Days` == FALSE)

CAIDI_leaflet_df <- CAIDI_leaflet_df %>%
  pivot_longer(
    cols = starts_with("20"),
    names_to = "Year",
    values_to = "CAIDI"
  )
```

```{r filter-2013, eval=FALSE}
CAIDI_2013 <- CAIDI_leaflet_df |>
  filter(Year == "2013")
###
CAIDI_2014 <- CAIDI_leaflet_df |>
  filter(Year == "2014")
###
CAIDI_2015 <- CAIDI_leaflet_df |>
  filter(Year == "2015")
###
CAIDI_2016 <- CAIDI_leaflet_df |>
  filter(Year == "2016")
###
CAIDI_2017 <- CAIDI_leaflet_df |>
  filter(Year == "2017")
###
CAIDI_2018 <- CAIDI_leaflet_df |>
  filter(Year == "2018")
###
CAIDI_2019 <- CAIDI_leaflet_df |>
  filter(Year == "2019")
###
CAIDI_2020 <- CAIDI_leaflet_df |>
  filter(Year == "2022")
###
CAIDI_2021 <- CAIDI_leaflet_df |>
  filter(Year == "2021")
###
CAIDI_2022 <- CAIDI_leaflet_df |>
  filter(Year == "2022")
```


```{r leaflet-CAIDI-bins&palette, eval=FALSE}
CAIDI_leaflet_df %>%
  #filter(Year == "2013") %>%
  summary("CAIDI")
  
bins <- seq(from = 26, to = 245, by = 25)

```

```{r pal-bins-setup-per-year, eval=FALSE}
palCAIDI_2013 <- colorBin("OrRd", domain = CAIDI_2013$CAIDI, bins = bins)

labels_2013 <- sprintf("<strong>%s</strong><br/>%g", 
                  CAIDI_2013$`Census Division\r\nand State`, CAIDI_2013$CAIDI) %>% lapply(htmltools::HTML)
######
palCAIDI_2014 <- colorBin("OrRd", domain = CAIDI_2014$CAIDI, bins = bins)

labels_2014 <- sprintf("<strong>%s</strong><br/>%g", 
                  CAIDI_2014$`Census Division\r\nand State`, CAIDI_2014$CAIDI) %>% lapply(htmltools::HTML)
###
palCAIDI_2015 <- colorBin("OrRd", domain = CAIDI_2015$CAIDI, bins = bins)

labels_2015 <- sprintf("<strong>%s</strong><br/>%g", 
                  CAIDI_2015$`Census Division\r\nand State`, CAIDI_2015$CAIDI) %>% lapply(htmltools::HTML)
###
palCAIDI_2016 <- colorBin("OrRd", domain = CAIDI_2016$CAIDI, bins = bins)

labels_2016 <- sprintf("<strong>%s</strong><br/>%g", 
                  CAIDI_2016$`Census Division\r\nand State`, CAIDI_2016$CAIDI) %>% lapply(htmltools::HTML)
###
palCAIDI_2017 <- colorBin("OrRd", domain = CAIDI_2017$CAIDI, bins = bins)

labels_2017 <- sprintf("<strong>%s</strong><br/>%g", 
                  CAIDI_2017$`Census Division\r\nand State`, CAIDI_2017$CAIDI) %>% lapply(htmltools::HTML)
###
palCAIDI_2018 <- colorBin("OrRd", domain = CAIDI_2018$CAIDI, bins = bins)

labels_2018 <- sprintf("<strong>%s</strong><br/>%g", 
                  CAIDI_2018$`Census Division\r\nand State`, CAIDI_2018$CAIDI) %>% lapply(htmltools::HTML)
###
palCAIDI_2019 <- colorBin("OrRd", domain = CAIDI_2019$CAIDI, bins = bins)

labels_2019 <- sprintf("<strong>%s</strong><br/>%g", 
                  CAIDI_2019$`Census Division\r\nand State`, CAIDI_2019$CAIDI) %>% lapply(htmltools::HTML)
###
palCAIDI_2020 <- colorBin("OrRd", domain = CAIDI_2020$CAIDI, bins = bins)

labels_2020 <- sprintf("<strong>%s</strong><br/>%g", 
                  CAIDI_2020$`Census Division\r\nand State`, CAIDI_2020$CAIDI) %>% lapply(htmltools::HTML)
###
palCAIDI_2021 <- colorBin("OrRd", domain = CAIDI_2021$CAIDI, bins = bins)

labels_2021 <- sprintf("<strong>%s</strong><br/>%g", 
                  CAIDI_2021$`Census Division\r\nand State`, CAIDI_2021$CAIDI) %>% lapply(htmltools::HTML)
###
palCAIDI_2022 <- colorBin("OrRd", domain = CAIDI_2022$CAIDI, bins = bins)

labels_2022 <- sprintf("<strong>%s</strong><br/>%g", 
                  CAIDI_2022$`Census Division\r\nand State`, CAIDI_2022$CAIDI) %>% lapply(htmltools::HTML)

```


```{r leaflet-CAIDI-years, eval=FALSE}
p1 <- CAIDI_2013 |>
leaflet() |>
  addTiles() |>
  setView(lng = -98.6,
          lat = 36.7,
          zoom = 4) |>
  addPolygons(
    fillColor = ~palCAIDI_2013(CAIDI_2013$CAIDI), 
    color = "white", 
    weight = 1,
    label = labels_2013)

p2 <- CAIDI_2014 |>
leaflet() |>
  addTiles() |>
  setView(lng = -98.6,
          lat = 36.7,
          zoom = 4) |>
  addPolygons(
    fillColor = ~palCAIDI_2014(CAIDI_2014$CAIDI), 
    color = "white", 
    weight = 1,
    label = labels_2014)

p3 <- CAIDI_2015 |>
leaflet() |>
  addTiles() |>
  setView(lng = -98.6,
          lat = 36.7,
          zoom = 4) |>
  addPolygons(
    fillColor = ~palCAIDI_2015(CAIDI_2015$CAIDI), 
    color = "white", 
    weight = 1,
    label = labels_2015)

p4 <- CAIDI_2016 |>
leaflet() |>
  addTiles() |>
  setView(lng = -98.6,
          lat = 36.7,
          zoom = 4) |>
  addPolygons(
    fillColor = ~palCAIDI_2016(CAIDI_2016$CAIDI), 
    color = "white", 
    weight = 1,
    label = labels_2016)

p5 <- CAIDI_2017 |>
leaflet() |>
  addTiles() |>
  setView(lng = -98.6,
          lat = 36.7,
          zoom = 4) |>
  addPolygons(
    fillColor = ~palCAIDI_2017(CAIDI_2017$CAIDI), 
    color = "white", 
    weight = 1,
    label = labels_2017)

p6 <- CAIDI_2018 |>
leaflet() |>
  addTiles() |>
  setView(lng = -98.6,
          lat = 36.7,
          zoom = 4) |>
  addPolygons(
    fillColor = ~palCAIDI_2018(CAIDI_2018$CAIDI), 
    color = "white", 
    weight = 1,
    label = labels_2018)

p7 <- CAIDI_2019 |>
leaflet() |>
  addTiles() |>
  setView(lng = -98.6,
          lat = 36.7,
          zoom = 4) |>
  addPolygons(
    fillColor = ~palCAIDI_2019(CAIDI_2019$CAIDI), 
    color = "white", 
    weight = 1,
    label = labels_2019)


p8 <- CAIDI_2020 |>
leaflet() |>
  addTiles() |>
  setView(lng = -98.6,
          lat = 36.7,
          zoom = 4) |>
  addPolygons(
    fillColor = ~palCAIDI_2020(CAIDI_2020$CAIDI), 
    color = "white", 
    weight = 1,
    label = labels_2020)

p9 <- CAIDI_2021 |>
leaflet() |>
  addTiles() |>
  setView(lng = -98.6,
          lat = 36.7,
          zoom = 4) |>
  addPolygons(
    fillColor = ~palCAIDI_2021(CAIDI_2021$CAIDI), 
    color = "white", 
    weight = 1,
    label = labels_2021)

p10 <- CAIDI_2022 |>
leaflet() |>
  addTiles() |>
  setView(lng = -98.6,
          lat = 36.7,
          zoom = 4) |>
  addPolygons(
    fillColor = ~palCAIDI_2022(CAIDI_2022$CAIDI), 
    color = "white", 
    weight = 1,
    label = labels_2022)
```

```{r leaflet-map-per-year, eval=FALSE}
p1
p2
p3
p4
p5
p6
p7
p8
p9
p10
```


## 3. Amount of electricity used, cheaper prices?
  - Q: Is it cheaper to buy electricity depending on the sector? Is buying electricity in bulk cheaper? 
  - ggplot(aes(x = Sales(mWh)/n of customers, y = average price, color = sectors))
  - Include the label of the average price per sector 

- compare this to experience in history: companies that consume lots of electricity usually get cheaper electricity prices because utilities had reliable demand from the industries
- electricity producers want reliable consumers --> does this bias still exist?
Book: "The Grid"


```{r average-price-in-kWH-consumption}
line_test <- energy_sector |>
  summarise(mean(`Average Price (cents/kWh)`, na.rm = TRUE),.by = Sector)

line_test$mean <- line_test$`mean(\`Average Price (cents/kWh)\`, na.rm = TRUE)` 

line_test$label <-
  round(line_test$mean, 2)

energy_sector |>
  ggplot(aes(x = ((
    `Sales (Megawatthours)`*1000)/`Customers (Count)`), y = `Average Price (cents/kWh)`, color = Sector)) +
  geom_point() +
  geom_smooth() +
  # geom_line(data = line_test, aes(y = mean)) +
  geom_hline(data = line_test, aes(yintercept = mean)) +
  geom_text(data = line_test, aes(50000000, y = label, label = label, vjust = -1), color = "black") +
  facet_wrap(~Sector) +
  xlim(0, 400000000) +
  labs(
    title = "Average KWh Consumption per Customer vs Average Price",
    subtitle = "by Sector in 2022",
    x = "Average KWh Consumption per Customer",
    y = "Average Price (cents/kWh)",
    caption = "Source : https://www.eia.gov/electricity/data.php#sales"
  )
```

## [4. Number of customers vs price by sector -- if we are bored, we can do this!
  - Q: Do bigger utility companies (meaning more customers) offer lower avg. prices due to scale?
  - ggplot(aes(x = avg price, y = customers)), facet( ~ sector)]
  
```{r price-by-#customers}
energy_sector |>
  filter(Sector == "Residential") |>
  ggplot(aes(x = `Customers (Count)`, y = `Average Price (cents/kWh)`)) +
  geom_point() +
  geom_smooth() +
  labs(title = "Average Price vs. Number of Customers", 
       subtitle = "per Utility company", 
       x = "Number of Customers", 
       y = "Average Price (cents/kWh)",
       caption = "Source : https://www.eia.gov/electricity/data.php#sales")
```


## 5. Per household consumption of electricity (megawatthours sold/customers) vs price 
  - Q: Do consumers use less electricity if it is more expensive? 
  - ggplot(aes(x = Sales/customers, y = avg. price))
  
```{r household-consumption-electricity}
ggplot(table_Residential, aes(x = (`Sales (Megawatthours)`*1000)/`Customers (Count)`, y = `Average Price (cents/kWh)`)) +
  geom_hex() +
  geom_smooth() +
  labs(title = "Electricity Consumption vs. Average Price", 
       subtitle = "in the Residential Sector", 
       x = "Average Electricity Consumption per Customer (in kWh)", 
       y = "Average Price (cents/kWh)", 
       fill = "Number of\nUtility\nCompanies",
       caption = "Source : https://www.eia.gov/electricity/data.php#sales")
```


### Stretch goal: 
## 6. Heatmap of the US' electricity use
  - Note: we might need long lat data to map the US states
  - Average per capita Sales per state (sum up all sales, group by state, calculate average), each box of the heatmap is one state
- goes together with 5.


