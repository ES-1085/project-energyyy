---
title: "Project Workspace"
author: "Energyyy"
output: github_document
---

```{r load-packages, message = FALSE}
library(tidyverse)
library(broom)
#install.packages("lubridate")
library(lubridate)
library(tidyr)
library(readxl)
#install.packages("leaflet")
library(leaflet)
```

```{r read-data}
table_Residential <- read_excel("/cloud/project/data/table_Residential.xlsx",
                                na = c("."))
table_Commercial <- read_excel("/cloud/project/data/table_Commercial.xlsx",
                               na = c("."))
table_Industrial <- read_excel("/cloud/project/data/table_Industrial.xlsx", 
                               na = c("."))
table_Transportation <- read_excel("/cloud/project/data/table_Transportation.xlsx", 
                                   na = c("."))
table_Disturbance <- read_excel("/cloud/project/data/table_Disturbance.xlsx",
                                na= c(".", ". Hours,  . Minutes", "Unknow", ".        ."))
table_CAIDI <- read_excel("/cloud/project/data/table_CAIDI.xlsx")

```

This mutate function adds a column which contains the sector of the data.
```{r mutate-to-sector}
residential <- table_Residential %>%
  mutate(Sector = c("Residential"))
commercial <- table_Commercial %>%
  mutate(Sector = c("Commercial"))
transportation <- table_Transportation %>%
  mutate(Sector = c("Transportation"))
industrial <- table_Industrial %>%
  mutate(Sector = c("Industrial"))
```

This code binds all the tables with sectors together. 
```{r bind-rows}
energy_sector <- bind_rows(residential, commercial, industrial, transportation)
glimpse(energy_sector)
```

```{r separate-duration-disturbance}
disturbance_unjoined <- table_Disturbance |>
  separate(col = Duration, into = c("Hours (Duration)", "Minutes (Duration)"), sep = ',') 

disturbance <- 
  rename(disturbance_unjoined, Entity = `Utility/Power Pool`) |>
  right_join(energy_sector, by = "Entity")

glimpse(disturbance)
```

```{r pivot-CAIDI}
table_CAIDI <- table_CAIDI |>
 pivot_longer(cols = `2013`:`2022`,
              names_to = "Year",
              values_to = "CAIDI")
```

1. Ownership vs price of electricity /according to sector 
- Q: Does ownership e.g. cooperatives influence the average price of electricity, does it benefit individuals/residential sector or is it more geared towards commercial sectorâ€¦?`

to-do:
- facet by sector (for readability)
- aes(color = ownership) to be able to compare the same ownership better in the different facets
- justify looking at this question, why it makes sense even though prices are mainly affected by fuel prices (we are looking at one year - 2022 - and different utility companies, we assume that they pay about the same for fuel)
- arrange x-axis in spectrum from cooperative to big corporation /catered to people or to profit (fct_relevel) 
  Order: Cooperative, municipal, political subdivision, state, federal, Behind the Meter (clarify what it is), retail power marketer, investor owned 
-- need to justify our levelling into this spectrum -- 
- geom_smooth - does that work on a boxplot? see if there is a trend on this cooperative-corporate spectrum for different sectors
- add labs() 
```{r ownership-average-price-state}
energy_sector |>
  filter(!is.na(Ownership)) |>
  mutate(
    Ownership = fct_relevel(
      Ownership,
      "Cooperative", "Municipal", "Political Subdivision", "State", "Federal", "Behind the Meter", "Retail Power Marketer", "Investor Owned"
    )) |>

 ggplot(aes(x = as.numeric(Ownership), y = `Average Price (cents/kWh)`)) +
  geom_boxplot(outlier.shape = NA, aes(color = Ownership)) +
  geom_smooth(method = "glm", color = "black") +
  ylim(0,25)+
  facet_wrap(~Sector) +
  scale_color_manual(values = c("Cooperative" = "#ffffd9", "Municipal" = "#edf8b1", "Political Subdivision" = "#c7e9b4", "State" = "#7fcdbb", "Federal" = "#41b6c4", "Behind the Meter" = "#1d91c0", "Retail Power Marketer" = "#225ea8", "Investor Owned" = "#0c2c84")) +
  theme(axis.text.x = element_text(
    angle = 45, vjust = 1, hjust  = 1), plot.margin = margin(1, 0.1, 1, 1, unit = "mm")) +
  labs(
    title = "Does ownership type of the utility company influence the average price of electricity?",
    subtitle = "Per sector based on 2022 data",
    caption = "Source : https://www.eia.gov/electricity/data.php#sales",
    x = ""
  )
#ggsave(filename = "plot1.png", device = "png")
```

2a. Revenue and actual blackouts and ownership 
  - Q: does less profit and community owned mean less blackouts? Or does ownership tell us that big companies have more means to prevent blackouts?

- aes(x = Revenue, y = n of blackouts, color = ownership) +
- geom_point()

- finish cleaning up company names in Excel
- join tables by utility company name

```{r count-disturbances-per-companies}
disturbance |> 
  group_by(Entity) |>
  count() |>
  arrange(n)
```

For the next plot we want to count the disturbances per utility company. However, we need to clean up the data first because some companies come up with different names. Hence, the mutate function. 
```{r mutate-to-group-same-companies-different-names}
disturbance |>
  mutate(Company = 
           case_when(
    `Entity` %in% 
      c("American Electric Power (Regulated Generation)", 
      "American Electric Power - (RFC Reliability Region) (8400 Smiths Mill Road, New Albany Ohio 43054)")
        ~ "American Electric Power", 
     `Entity` %in% 
      c("Baltimore Gas & Electric Co", 	
"Baltimore Gas and Electric") ~ "Baltimore Gas & Electric",
     TRUE ~ as.character(as.character(`Entity`))
    )) |>
    group_by(Company) |>
  count()
  
#ggplot(aes(x = `Average Price (cents/kWh)`, y = `Revenues (Thousands Dollars)`, size = n of blackouts/in categories)), facet(~ ownership)
```
  
2b. CAIDI reliability in electricity networks throughout the US based on states
Q: How does CAIDI vary throughout the US states? 
Animate leaflet from 2013-2022. 
```{r}
summary(table_CAIDI$CAIDI)
bins <- seq(from = 0, to = 1500, by = 300)
palCAIDI <- colorBin("BuPu", domain = table_CAIDI$CAIDI, bins = bins)
```

```{r}

leaflet(data = table_CAIDI) |>
  addTiles() |>
  setView(lng = -98.6,
          lat = 36.7,
          zoom = 4) |>
addPolygons(fillColor = ~ palCAIDI(table_CAIDI$CAIDI))
```

- use sequential color scheme for Index
- import/upload data and tidy it

3. Amount of electricity used, cheaper prices?
  - Q: Is it cheaper to buy electricity depending on the sector? Is buying electricity in bulk cheaper? 
  - ggplot(aes(x = Sales(mWh)/n of customers, y = average price, color = sectors))

- compare this to experience in history: companies that consume lots of electricity usually get cheaper electricity prices because utilities had reliable demand from the industries
- electricity producers want reliable consumers --> does this bias still exist?
Book: "The Grid"

[4. Number of customers vs price by sector -- if we are bored, we can do this!
  - Q: Do bigger utility companies (meaning more customers) offer lower avg. prices due to scale?
  - ggplot(aes(x = avg price, y = customers)), facet( ~ sector)]

5. Per household consumption of electricity (megawatthours sold/customers) vs price 
  - Q: Do consumers use less electricity if it is more expensive? 
  - ggplot(aes(x = Sales/customers, y = avg. price))

Stretch goals: 
6. Heatmap of the US' electricity use
  - Note: we might need long lat data to map the US states
  - Average per capita Sales per state (sum up all sales, group by state, calculate average), each box of the heatmap is one state
- goes together with 5.
